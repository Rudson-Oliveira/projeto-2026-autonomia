<template>
  <div class="vulnerability-dashboard">
    <!-- Header -->
    <div class="dashboard-header">
      <h2>üìä An√°lise de Vulnerabilidade e Margem</h2>
      <p class="subtitle">Perfil Comportamental | Rede de Apoio | Gest√£o de Margens</p>
    </div>

    <!-- Filtros -->
    <div class="filters-section">
      <input 
        v-model="filters.clientName" 
        type="text" 
        placeholder="Buscar por cliente..." 
        class="filter-input"
      />
      <select v-model="filters.complexity" class="filter-select">
        <option value="">Todas as Complexidades</option>
        <option value="baixa">Baixa Complexidade</option>
        <option value="media">M√©dia Complexidade</option>
        <option value="alta">Alta Complexidade</option>
      </select>
      <select v-model="filters.marginStatus" class="filter-select">
        <option value="">Todas as Margens</option>
        <option value="saudavel">Margem Saud√°vel (‚â•20%)</option>
        <option value="alerta">Alerta (15-20%)</option>
        <option value="critica">Cr√≠tica (<15%)</option>
      </select>
    </div>

    <!-- Cards de Resumo -->
    <div class="summary-cards">
      <div class="card card-vulnerability">
        <h3>üè• Vulnerabilidades Detectadas</h3>
        <p class="card-value">{{ vulnerabilityCount }}</p>
        <p class="card-subtitle">Casos com risco elevado</p>
      </div>
      <div class="card card-margin">
        <h3>üí∞ Margens Cr√≠ticas</h3>
        <p class="card-value">{{ criticalMarginCount }}</p>
        <p class="card-subtitle">Itens com margem < 20%</p>
      </div>
      <div class="card card-support">
        <h3>ü§ù Rede de Apoio</h3>
        <p class="card-value">{{ supportNetworkScore }}%</p>
        <p class="card-subtitle">Cobertura de profissionais</p>
      </div>
    </div>

    <!-- Tabela de Or√ßamentos com An√°lise -->
    <div class="table-section">
      <h3>üìã Or√ßamentos com An√°lise de Vulnerabilidade</h3>
      <table class="analysis-table">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Complexidade</th>
            <th>Perfil Comportamental</th>
            <th>Margem Lucro</th>
            <th>Rede de Apoio</th>
            <th>Status</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="budget in filteredBudgets" :key="budget.id" :class="budget.riskLevel">
            <td class="client-name">{{ budget.clientName }}</td>
            <td class="complexity" :class="budget.complexity">
              {{ complexityLabel(budget.complexity) }}
            </td>
            <td class="behavioral">
              <span class="badge" :class="budget.behavioralProfile">
                {{ behavioralLabel(budget.behavioralProfile) }}
              </span>
            </td>
            <td class="margin" :class="marginStatus(budget.marginPercentage)">
              {{ budget.marginPercentage }}%
              <span class="margin-status">{{ marginStatusLabel(budget.marginPercentage) }}</span>
            </td>
            <td class="support-network">
              <div class="network-indicator">
                <div class="network-bar" :style="{ width: budget.supportNetworkCoverage + '%' }"></div>
              </div>
              {{ budget.supportNetworkCoverage }}%
            </td>
            <td class="status">
              <span class="status-badge" :class="budget.riskLevel">
                {{ riskLevelLabel(budget.riskLevel) }}
              </span>
            </td>
            <td class="actions">
              <button @click="viewDetails(budget)" class="btn-details">Detalhes</button>
              <button @click="editMargin(budget)" class="btn-edit">Ajustar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Modal de Detalhes -->
    <div v-if="selectedBudget" class="modal-overlay" @click="selectedBudget = null">
      <div class="modal-content" @click.stop>
        <button class="modal-close" @click="selectedBudget = null">&times;</button>
        <h3>üìä Detalhes da An√°lise - {{ selectedBudget.clientName }}</h3>
        
        <div class="modal-section">
          <h4>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Perfil Comportamental</h4>
          <p><strong>Grau de Ansiedade:</strong> {{ selectedBudget.anxietyLevel }}</p>
          <p><strong>Expectativas:</strong> {{ selectedBudget.expectations }}</p>
          <p><strong>Vulnerabilidades Identificadas:</strong></p>
          <ul>
            <li v-for="vuln in selectedBudget.vulnerabilities" :key="vuln">{{ vuln }}</li>
          </ul>
        </div>

        <div class="modal-section">
          <h4>üí∞ An√°lise de Margens</h4>
          <table class="margin-table">
            <tr>
              <td>Pre√ßo de Venda:</td>
              <td class="value">R$ {{ selectedBudget.salePrice.toFixed(2) }}</td>
            </tr>
            <tr>
              <td>Pre√ßo de Compra:</td>
              <td class="value">R$ {{ selectedBudget.costPrice.toFixed(2) }}</td>
            </tr>
            <tr>
              <td>Custo Log√≠stico:</td>
              <td class="value">R$ {{ selectedBudget.logisticCost.toFixed(2) }}</td>
            </tr>
            <tr class="total-row">
              <td>Margem L√≠quida:</td>
              <td class="value" :class="marginStatus(selectedBudget.marginPercentage)">
                {{ selectedBudget.marginPercentage }}%
              </td>
            </tr>
          </table>
        </div>

        <div class="modal-section">
          <h4>ü§ù Rede de Apoio</h4>
          <p><strong>Profissionais Dispon√≠veis:</strong> {{ selectedBudget.availableProfessionals }}</p>
          <p><strong>Farm√°cias Pr√≥ximas:</strong> {{ selectedBudget.nearbyPharmacies }}</p>
          <p><strong>Distribuidoras de Equipamentos:</strong> {{ selectedBudget.equipmentDistributors }}</p>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'VulnerabilityDashboard',
  data() {
    return {
      filters: {
        clientName: '',
        complexity: '',
        marginStatus: ''
      },
      selectedBudget: null,
      budgets: [
        {
          id: 1,
          clientName: 'Jo√£o Silva',
          complexity: 'alta',
          behavioralProfile: 'ansioso',
          marginPercentage: 18,
          supportNetworkCoverage: 85,
          riskLevel: 'alto',
          anxietyLevel: 'Alto',
          expectations: 'Visitas di√°rias, suporte 24h',
          vulnerabilities: [
            'Fam√≠lia com expectativas acima do plano terap√™utico',
            'Hist√≥rico de reclama√ß√µes',
            'Localiza√ß√£o com rede de apoio limitada'
          ],
          salePrice: 1500,
          costPrice: 1200,
          logisticCost: 150,
          availableProfessionals: 3,
          nearbyPharmacies: 2,
          equipmentDistributors: 1
        },
        {
          id: 2,
          clientName: 'Maria Santos',
          complexity: 'media',
          behavioralProfile: 'colaborativo',
          marginPercentage: 22,
          supportNetworkCoverage: 90,
          riskLevel: 'medio',
          anxietyLevel: 'M√©dio',
          expectations: 'Visitas 3x por semana',
          vulnerabilities: [
            'Custo de transporte elevado'
          ],
          salePrice: 1200,
          costPrice: 900,
          logisticCost: 100,
          availableProfessionals: 5,
          nearbyPharmacies: 4,
          equipmentDistributors: 2
        },
        {
          id: 3,
          clientName: 'Pedro Costa',
          complexity: 'baixa',
          behavioralProfile: 'independente',
          marginPercentage: 28,
          supportNetworkCoverage: 95,
          riskLevel: 'baixo',
          anxietyLevel: 'Baixo',
          expectations: 'Visitas 1x por semana',
          vulnerabilities: [],
          salePrice: 800,
          costPrice: 550,
          logisticCost: 50,
          availableProfessionals: 8,
          nearbyPharmacies: 6,
          equipmentDistributors: 3
        }
      ]
    };
  },
  computed: {
    filteredBudgets() {
      return this.budgets.filter(budget => {
        const matchesName = budget.clientName.toLowerCase().includes(this.filters.clientName.toLowerCase());
        const matchesComplexity = !this.filters.complexity || budget.complexity === this.filters.complexity;
        const matchesMargin = !this.filters.marginStatus || 
          (this.filters.marginStatus === 'saudavel' && budget.marginPercentage >= 20) ||
          (this.filters.marginStatus === 'alerta' && budget.marginPercentage >= 15 && budget.marginPercentage < 20) ||
          (this.filters.marginStatus === 'critica' && budget.marginPercentage < 15);
        return matchesName && matchesComplexity && matchesMargin;
      });
    },
    vulnerabilityCount() {
      return this.budgets.filter(b => b.riskLevel === 'alto').length;
    },
    criticalMarginCount() {
      return this.budgets.filter(b => b.marginPercentage < 20).length;
    },
    supportNetworkScore() {
      const avg = this.budgets.reduce((sum, b) => sum + b.supportNetworkCoverage, 0) / this.budgets.length;
      return Math.round(avg);
    }
  },
  methods: {
    complexityLabel(complexity) {
      const labels = {
        'baixa': 'Baixa Complexidade',
        'media': 'M√©dia Complexidade',
        'alta': 'Alta Complexidade'
      };
      return labels[complexity] || complexity;
    },
    behavioralLabel(profile) {
      const labels = {
        'ansioso': 'üò∞ Ansioso',
        'colaborativo': 'ü§ù Colaborativo',
        'independente': 'ü¶Å Independente'
      };
      return labels[profile] || profile;
    },
    marginStatus(margin) {
      if (margin >= 20) return 'saudavel';
      if (margin >= 15) return 'alerta';
      return 'critica';
    },
    marginStatusLabel(margin) {
      if (margin >= 20) return '‚úÖ OK';
      if (margin >= 15) return '‚ö†Ô∏è Alerta';
      return 'üî¥ Cr√≠tica';
    },
    riskLevelLabel(level) {
      const labels = {
        'alto': 'üî¥ Alto Risco',
        'medio': 'üü° Risco M√©dio',
        'baixo': 'üü¢ Baixo Risco'
      };
      return labels[level] || level;
    },
    viewDetails(budget) {
      this.selectedBudget = budget;
    },
    editMargin(budget) {
      alert(`Editar margem para ${budget.clientName}`);
      // Implementar modal de edi√ß√£o de margem
    }
  }
};
</script>

<style scoped>
:root {
  --verde-turquesa: #59C2C9;
  --azul-intenso: #1A3688;
  --cinza-claro: #f5f5f5;
  --cinza-escuro: #333;
  --vermelho: #e74c3c;
  --amarelo: #f39c12;
  --verde: #27ae60;
}

.vulnerability-dashboard {
  padding: 20px;
  background-color: var(--cinza-claro);
  min-height: 100vh;
}

.dashboard-header {
  margin-bottom: 30px;
  border-bottom: 3px solid var(--verde-turquesa);
  padding-bottom: 15px;
}

.dashboard-header h2 {
  color: var(--azul-intenso);
  font-size: 28px;
  margin: 0 0 5px 0;
}

.subtitle {
  color: #666;
  font-size: 14px;
  margin: 0;
}

.filters-section {
  display: flex;
  gap: 15px;
  margin-bottom: 25px;
  flex-wrap: wrap;
}

.filter-input,
.filter-select {
  padding: 10px 15px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-size: 14px;
  background-color: white;
}

.filter-input:focus,
.filter-select:focus {
  outline: none;
  border-color: var(--verde-turquesa);
  box-shadow: 0 0 5px rgba(89, 194, 201, 0.3);
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.card {
  background-color: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-left: 5px solid var(--verde-turquesa);
}

.card h3 {
  margin: 0 0 10px 0;
  font-size: 16px;
  color: var(--azul-intenso);
}

.card-value {
  font-size: 32px;
  font-weight: bold;
  color: var(--verde-turquesa);
  margin: 10px 0;
}

.card-subtitle {
  font-size: 12px;
  color: #999;
  margin: 0;
}

.card-vulnerability {
  border-left-color: var(--vermelho);
}

.card-margin {
  border-left-color: var(--amarelo);
}

.card-support {
  border-left-color: var(--verde);
}

.table-section {
  background-color: white;
  border-radius: 8px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.table-section h3 {
  color: var(--azul-intenso);
  margin-top: 0;
}

.analysis-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.analysis-table thead {
  background-color: var(--azul-intenso);
  color: white;
}

.analysis-table th {
  padding: 15px;
  text-align: left;
  font-weight: 600;
}

.analysis-table td {
  padding: 12px 15px;
  border-bottom: 1px solid #eee;
}

.analysis-table tbody tr:hover {
  background-color: #f9f9f9;
}

.analysis-table tbody tr.alto {
  background-color: #ffe6e6;
}

.analysis-table tbody tr.medio {
  background-color: #fff9e6;
}

.analysis-table tbody tr.baixo {
  background-color: #e6f9e6;
}

.client-name {
  font-weight: 600;
  color: var(--azul-intenso);
}

.complexity {
  font-weight: 500;
}

.complexity.alta {
  color: var(--vermelho);
}

.complexity.media {
  color: var(--amarelo);
}

.complexity.baixa {
  color: var(--verde);
}

.behavioral .badge {
  display: inline-block;
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
}

.behavioral .badge.ansioso {
  background-color: #ffe6e6;
  color: var(--vermelho);
}

.behavioral .badge.colaborativo {
  background-color: #e6f0ff;
  color: var(--azul-intenso);
}

.behavioral .badge.independente {
  background-color: #e6f9e6;
  color: var(--verde);
}

.margin {
  font-weight: 600;
}

.margin.saudavel {
  color: var(--verde);
}

.margin.alerta {
  color: var(--amarelo);
}

.margin.critica {
  color: var(--vermelho);
}

.margin-status {
  display: block;
  font-size: 11px;
  font-weight: normal;
}

.support-network {
  position: relative;
}

.network-indicator {
  width: 100%;
  height: 6px;
  background-color: #eee;
  border-radius: 3px;
  margin-bottom: 5px;
  overflow: hidden;
}

.network-bar {
  height: 100%;
  background-color: var(--verde-turquesa);
  transition: width 0.3s ease;
}

.status-badge {
  display: inline-block;
  padding: 5px 10px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
}

.status-badge.alto {
  background-color: #ffe6e6;
  color: var(--vermelho);
}

.status-badge.medio {
  background-color: #fff9e6;
  color: var(--amarelo);
}

.status-badge.baixo {
  background-color: #e6f9e6;
  color: var(--verde);
}

.actions {
  display: flex;
  gap: 8px;
}

.btn-details,
.btn-edit {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-details {
  background-color: var(--azul-intenso);
  color: white;
}

.btn-details:hover {
  background-color: #0d1f47;
}

.btn-edit {
  background-color: var(--verde-turquesa);
  color: white;
}

.btn-edit:hover {
  background-color: #47a0a6;
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.modal-content {
  background-color: white;
  border-radius: 8px;
  padding: 30px;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  position: relative;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.modal-close {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  font-size: 28px;
  cursor: pointer;
  color: #999;
}

.modal-close:hover {
  color: var(--azul-intenso);
}

.modal-content h3 {
  color: var(--azul-intenso);
  margin-top: 0;
}

.modal-section {
  margin-bottom: 25px;
  padding-bottom: 20px;
  border-bottom: 1px solid #eee;
}

.modal-section:last-child {
  border-bottom: none;
}

.modal-section h4 {
  color: var(--verde-turquesa);
  margin: 0 0 15px 0;
}

.modal-section p {
  margin: 8px 0;
  color: #333;
}

.modal-section ul {
  margin: 10px 0;
  padding-left: 20px;
}

.modal-section li {
  margin: 5px 0;
  color: #666;
}

.margin-table {
  width: 100%;
  border-collapse: collapse;
}

.margin-table tr {
  border-bottom: 1px solid #eee;
}

.margin-table td {
  padding: 10px;
}

.margin-table td:first-child {
  font-weight: 500;
  color: #666;
}

.margin-table .value {
  text-align: right;
  font-weight: 600;
}

.margin-table .total-row {
  background-color: var(--cinza-claro);
}

.margin-table .total-row td {
  padding: 12px 10px;
  font-weight: 600;
}

/* Responsivo */
@media (max-width: 768px) {
  .filters-section {
    flex-direction: column;
  }

  .filter-input,
  .filter-select {
    width: 100%;
  }

  .summary-cards {
    grid-template-columns: 1fr;
  }

  .analysis-table {
    font-size: 12px;
  }

  .analysis-table th,
  .analysis-table td {
    padding: 10px;
  }

  .actions {
    flex-direction: column;
  }

  .btn-details,
  .btn-edit {
    width: 100%;
  }

  .modal-content {
    max-width: 90vw;
    padding: 20px;
  }
}
</style>
